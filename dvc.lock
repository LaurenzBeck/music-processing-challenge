schema: '2.0'
stages:
  train_val_split:
    cmd: python challenges/train_val_split.py
    deps:
    - path: challenges/train_val_split.py
      md5: 9939832f90ddf6b28335aaafd6cba70a
      size: 1098
    - path: data/raw/train
      md5: a4da05829c6006bb7be263752f10e8b1.dir
      size: 215577173
      nfiles: 508
    params:
      params.yaml:
        data_dir_train: data/raw/train
        seed: 42
        train_val_split: 0.8
    outs:
    - path: data/processed/train_files.pkl
      md5: 35601749b160f97984b0586236f95ff4
      size: 3542
    - path: data/processed/val_files.pkl
      md5: 7448303f28d0ede78d0c619dbe1ae7ea
      size: 911
  featurize:
    cmd: python challenges/onset-detection/extract_features.py
    deps:
    - path: challenges/onset-detection/extract_features.py
      md5: fd90563996213e50dc38f3efda82067a
      size: 6424
    - path: data/processed/train_files.pkl
      md5: 35601749b160f97984b0586236f95ff4
      size: 3542
    - path: data/processed/val_files.pkl
      md5: 7448303f28d0ede78d0c619dbe1ae7ea
      size: 911
    - path: data/raw/test
      md5: 01ed73995bbf40999fbd40737fcd67e4.dir
      size: 67482988
      nfiles: 50
    params:
      params.yaml:
        data_dir_test: data/raw/test
        featurize:
          fps: 5.0
          frame_size: 6615
          ewm_spans:
          - 3
          - 6
          - 9
          - 12
    outs:
    - path: data/interim/
      md5: 553ae8f52bd0078153e75b8a471a6d1c.dir
      size: 14152937
      nfiles: 14160
  prepare_labels:
    cmd: python challenges/onset-detection/prepare_labels.py
    deps:
    - path: challenges/onset-detection/prepare_labels.py
      md5: badcf59a38acc805fe5686982a16226b
      size: 2433
    - path: data/processed/train_files.pkl
      md5: 35601749b160f97984b0586236f95ff4
      size: 3542
    - path: data/processed/val_files.pkl
      md5: 7448303f28d0ede78d0c619dbe1ae7ea
      size: 911
    params:
      params.yaml:
        featurize.fps: 5.0
    outs:
    - path: data/processed/train/labels/
      md5: 4f10b055674d408d45e45fbbf5d8b37f.dir
      size: 52112
      nfiles: 101
    - path: data/processed/val/labels/
      md5: 1c5999f742f3a0d7897f34e6fe4fbde1.dir
      size: 12089
      nfiles: 26
  combine_features:
    cmd: python challenges/onset-detection/combine_features_to_dataframe.py
    deps:
    - path: challenges/onset-detection/combine_features_to_dataframe.py
      md5: 22619d902ff6baa5710562c9c6f37bdc
      size: 2729
    - path: data/interim/
      md5: 553ae8f52bd0078153e75b8a471a6d1c.dir
      size: 14152937
      nfiles: 14160
    - path: data/processed/train/labels
      md5: 4f10b055674d408d45e45fbbf5d8b37f.dir
      size: 52112
      nfiles: 101
    - path: data/processed/val/labels
      md5: 1c5999f742f3a0d7897f34e6fe4fbde1.dir
      size: 12089
      nfiles: 26
    params:
      params.yaml:
        featurize.fps: 5.0
        featurize.frame_size: 6615
    outs:
    - path: data/processed/test/data.csv
      md5: c90de4b8dbc18912bcc25da79b41a9ad
      size: 3040976
    - path: data/processed/train/data.csv
      md5: d8b91309a4e5ebe63ddd05a408916c42
      size: 8032667
    - path: data/processed/val/data.csv
      md5: 2d860a012f37dde08648e97d2ca932bc
      size: 1859618
  train:
    cmd: python challenges/onset-detection/train.py
    deps:
    - path: challenges/onset-detection/train.py
      md5: 25cd45b504fac2f71259d4afd24b0414
      size: 2322
    - path: data/processed/train/data.csv
      md5: d8b91309a4e5ebe63ddd05a408916c42
      size: 8032667
    - path: data/processed/val/data.csv
      md5: 2d860a012f37dde08648e97d2ca932bc
      size: 1859618
    params:
      params.yaml:
        seed: 42
        train:
          batch_size: 128
          epochs: 32
          learning_rate: 0.006
          weight_decay: 0.0001
          model_file_name: fastai-tabular
          layers:
          - 512
          - 256
          - 256
          - 128
          - 128
          dropout_probs:
          - 0.0
          - 0.2
          - 0.15
          - 0.1
          - 0.05
    outs:
    - path: dvclive.json
      md5: d52d9f62d548538b5f561f7bf7431821
      size: 364
    - path: dvclive/scalars
      md5: 2289dcb7a400ab3be292636e06033e83.dir
      size: 7904
      nfiles: 7
    - path: models/fastai-tabular.pth
      md5: ca3d428cf9d959d2c2b27c78c4d2a935
      size: 4282299
  predict:
    cmd: python challenges/onset-detection/test.py
    deps:
    - path: challenges/onset-detection/test.py
      md5: c78e18eb2efeb3a834669bf2b234626c
      size: 4827
    - path: data/processed/test/data.csv
      md5: c90de4b8dbc18912bcc25da79b41a9ad
      size: 3040976
    - path: data/processed/train/data.csv
      md5: d8b91309a4e5ebe63ddd05a408916c42
      size: 8032667
    - path: data/processed/val/data.csv
      md5: 2d860a012f37dde08648e97d2ca932bc
      size: 1859618
    - path: models/fastai-tabular.pth
      md5: ca3d428cf9d959d2c2b27c78c4d2a935
      size: 4282299
    params:
      params.yaml:
        seed: 42
        train.batch_size: 128
        train.model_file_name: fastai-tabular
    outs:
    - path: reports/test-df.csv
      md5: 99f316a114f7b9b0a1bc875b1c957800
      size: 115938
    - path: reports/test-onsets.json
      md5: f6c4651583131aff0ac9724140d469f9
      size: 42914
    - path: reports/val-df.csv
      md5: 1af100d7c3c6edb7c56aaccf7bd98e31
      size: 114554
    - path: reports/val-onsets.json
      md5: bbbfa6cf013b590dc315f4381bdea73f
      size: 26431
    - path: reports/val-targets.json
      md5: 54c37dd8a96f818623d2e7897612f12c
      size: 26314
  evaluate:
    cmd: python challenges/onset-detection/eval_onsets.py --submission reports/val-onsets.json
      --target reports/val-targets.json
    deps:
    - path: challenges/onset-detection/eval_onsets.py
      md5: 404f1b7387c917ae73a9c3010aa60874
      size: 1796
    - path: reports/val-onsets.json
      md5: bbbfa6cf013b590dc315f4381bdea73f
      size: 26431
    - path: reports/val-targets.json
      md5: 54c37dd8a96f818623d2e7897612f12c
      size: 26314
    outs:
    - path: metrics.json
      md5: 12f2909d19b87396892da2718280c4ee
      size: 42
