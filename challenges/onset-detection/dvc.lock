schema: '2.0'
stages:
  train_val_split:
    cmd: python challenges/train_val_split.py
    deps:
    - path: challenges/train_val_split.py
      md5: 9939832f90ddf6b28335aaafd6cba70a
      size: 1098
    - path: data/raw/train
      md5: a4da05829c6006bb7be263752f10e8b1.dir
      size: 215577173
      nfiles: 508
    params:
      params.yaml:
        data_dir_train: data/raw/train
        seed: 42
        train_val_split: 0.8
    outs:
    - path: data/processed/train_files.pkl
      md5: 35601749b160f97984b0586236f95ff4
      size: 3542
    - path: data/processed/val_files.pkl
      md5: 7448303f28d0ede78d0c619dbe1ae7ea
      size: 911
  featurize:
    cmd: python challenges/onset-detection/extract_features.py
    deps:
    - path: challenges/onset-detection/extract_features.py
      md5: 191348841f6dafc1ae57698605a6bb16
      size: 7102
    - path: data/processed/train_files.pkl
      md5: 35601749b160f97984b0586236f95ff4
      size: 3542
    - path: data/processed/val_files.pkl
      md5: 7448303f28d0ede78d0c619dbe1ae7ea
      size: 911
    - path: data/raw/test
      md5: 01ed73995bbf40999fbd40737fcd67e4.dir
      size: 67482988
      nfiles: 50
    params:
      params.yaml:
        data_dir_test: data/raw/test
        onset_detection.featurize:
          fps: 14.0
          frame_size: 3150
          ewm_spans:
          - 3
          - 6
    outs:
    - path: data/interim/onset-detection/
      md5: 0d58d435cdfab67f62b5b06a3809e717.dir
      size: 23608099
      nfiles: 8496
  prepare_labels:
    cmd: python challenges/onset-detection/prepare_labels.py
    deps:
    - path: challenges/onset-detection/prepare_labels.py
      md5: e8af70052d1d01476a7cc6420638f4c8
      size: 2532
    - path: data/processed/train_files.pkl
      md5: 35601749b160f97984b0586236f95ff4
      size: 3542
    - path: data/processed/val_files.pkl
      md5: 7448303f28d0ede78d0c619dbe1ae7ea
      size: 911
    params:
      params.yaml:
        onset_detection.featurize.fps: 14.0
    outs:
    - path: data/processed/onset-detection/train/labels/
      md5: 48ac2dda03320b410b78b0f3f1207bab.dir
      size: 156372
      nfiles: 101
    - path: data/processed/onset-detection/val/labels/
      md5: b070c2d2b076de75d12f36ee48c569a2.dir
      size: 36341
      nfiles: 26
  combine_features:
    cmd: python challenges/onset-detection/combine_features_to_dataframe.py
    deps:
    - path: challenges/onset-detection/combine_features_to_dataframe.py
      md5: 12a1da8c7d6276213cd8694b79bed095
      size: 2982
    - path: data/interim/onset-detection/
      md5: 0d58d435cdfab67f62b5b06a3809e717.dir
      size: 23608099
      nfiles: 8496
    - path: data/processed/onset-detection/train/labels
      md5: 48ac2dda03320b410b78b0f3f1207bab.dir
      size: 156372
      nfiles: 101
    - path: data/processed/onset-detection/val/labels
      md5: b070c2d2b076de75d12f36ee48c569a2.dir
      size: 36341
      nfiles: 26
    params:
      params.yaml:
        onset_detection.featurize.fps: 14.0
        onset_detection.featurize.frame_size: 3150
    outs:
    - path: data/processed/onset-detection/test/data.csv
      md5: 80e7fa454e40892f0799bacdf0cb4a1c
      size: 5293355
    - path: data/processed/onset-detection/train/data.csv
      md5: 9ce764b68ea9a1854e5fa856e2549fc8
      size: 14154272
    - path: data/processed/onset-detection/val/data.csv
      md5: 8f486bf49d1ec1b6516c9a658cc046c0
      size: 3262237
  train:
    cmd: python challenges/onset-detection/train.py
    deps:
    - path: challenges/onset-detection/train.py
      md5: 0f6c72a776e4c248a5e212a4cf1d1d74
      size: 2659
    - path: data/processed/onset-detection/train/data.csv
      md5: 9ce764b68ea9a1854e5fa856e2549fc8
      size: 14154272
    - path: data/processed/onset-detection/val/data.csv
      md5: 8f486bf49d1ec1b6516c9a658cc046c0
      size: 3262237
    params:
      params.yaml:
        onset_detection.train:
          batch_size: 128
          epochs: 32
          learning_rate: 0.003
          weight_decay: 0.0003
          model_file_name: fastai-tabular-onset-detector
          layers:
          - 256
          - 128
          - 128
          dropout_probs:
          - 0.05
          - 0.1
          - 0.15
        seed: 42
    outs:
    - path: models/fastai-tabular-onset-detector.pth
      md5: 594dcaba1fd7bae6624a984fa875fde7
      size: 1015947
    - path: reports/onset-detection/dvclive.json
      md5: 261656012190bde5f815c8260d722e53
      size: 360
    - path: reports/onset-detection/dvclive/scalars
      md5: 2064d171a7381d97e9d09becf335ac86.dir
      size: 7961
      nfiles: 7
  predict:
    cmd: python challenges/onset-detection/test.py
    deps:
    - path: challenges/onset-detection/test.py
      md5: d153c949d0b314eccf7342bad790ec0c
      size: 5152
    - path: data/processed/onset-detection/test/data.csv
      md5: 80e7fa454e40892f0799bacdf0cb4a1c
      size: 5293355
    - path: data/processed/onset-detection/train/data.csv
      md5: 9ce764b68ea9a1854e5fa856e2549fc8
      size: 14154272
    - path: data/processed/onset-detection/val/data.csv
      md5: 8f486bf49d1ec1b6516c9a658cc046c0
      size: 3262237
    - path: models/fastai-tabular-onset-detector.pth
      md5: 594dcaba1fd7bae6624a984fa875fde7
      size: 1015947
    params:
      params.yaml:
        onset_detection.train.batch_size: 128
        onset_detection.train.model_file_name: fastai-tabular-onset-detector
        seed: 42
    outs:
    - path: reports/onset-detection/test-df.csv
      md5: 9f81ac3f8ac399334cdc4f52c124becf
      size: 430736
    - path: reports/onset-detection/test-onsets.json
      md5: e307b98eafce0f3281c88869ca195d29
      size: 113827
    - path: reports/onset-detection/val-df.csv
      md5: 09b91396b8786c820bcd46101c53e786
      size: 386299
    - path: reports/onset-detection/val-onsets.json
      md5: 2b2512abcc3a5a404fecb0245cfb838c
      size: 73362
    - path: reports/onset-detection/val-targets.json
      md5: 62a7527ed7030dcf21e3a4bdab1d1c66
      size: 61122
  evaluate:
    cmd: python challenges/onset-detection/eval_onsets.py --submission reports/onset-detection/val-onsets.json
      --target reports/onset-detection/val-targets.json
    deps:
    - path: challenges/onset-detection/eval_onsets.py
      md5: b2a635d3ed0153f6ce8fa30fe23e0967
      size: 1820
    - path: reports/onset-detection/val-onsets.json
      md5: 2b2512abcc3a5a404fecb0245cfb838c
      size: 73362
    - path: reports/onset-detection/val-targets.json
      md5: 62a7527ed7030dcf21e3a4bdab1d1c66
      size: 61122
    outs:
    - path: reports/onset-detection/metrics.json
      md5: 626a45b6b908617ffa5c1a5ff8ae1ce3
      size: 41
